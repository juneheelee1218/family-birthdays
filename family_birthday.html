<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Family Birthdays</title>

  <!-- SheetJS (XLSX parser) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root{
      --bg:#faf7f3;
      --ink:#222;
      --muted:#666;
      --card:#fff;
      --shadow: 0 10px 25px rgba(0,0,0,.08);
      --radius: 18px;
      --tab:#ffffffcc;
      --tabActive:#222;
      --tabActiveText:#fff;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple SD Gothic Neo", "Noto Sans KR", sans-serif;
      background: var(--bg);
      color: var(--ink);
    }
    .wrap{
      max-width: 1100px;
      margin: 26px auto 60px;
      padding: 0 18px;
    }
    header{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap: 16px;
      flex-wrap:wrap;
      margin-bottom: 12px;
    }
    h1{
      margin:0;
      font-size: 56px;
      line-height: .95;
      letter-spacing: -1px;
      font-weight: 800;
    }
    .sub{
      margin:8px 0 0;
      color: var(--muted);
      font-size: 14px;
    }

    /* Controls */
    .controls{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:flex-end;
      flex-wrap:wrap;
    }
    .btn{
      border: 1px solid rgba(0,0,0,.12);
      background: #fff;
      padding: 10px 12px;
      border-radius: 12px;
      cursor:pointer;
      font-weight: 800;
    }
    .hint{
      color: var(--muted);
      font-size: 12px;
    }

    /* Year tabs */
    .tabs{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      justify-content:flex-end;
      margin-top: 10px;
    }
    .tab{
      border: 1px solid rgba(0,0,0,.1);
      background: var(--tab);
      padding: 10px 14px;
      border-radius: 999px;
      cursor:pointer;
      font-weight: 800;
      color: var(--ink);
      transition: transform .08s ease, background .2s ease;
      user-select:none;
    }
    .tab:hover{ transform: translateY(-1px); }
    .tab.active{
      background: var(--tabActive);
      color: var(--tabActiveText);
      border-color: transparent;
    }

    /* Grid */
    .grid{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 18px;
      margin-top: 18px;
    }
    @media (max-width: 980px){
      h1{font-size:44px}
      .grid{grid-template-columns: repeat(3, 1fr);}
    }
    @media (max-width: 720px){
      .grid{grid-template-columns: repeat(2, 1fr);}
      h1{font-size:38px}
    }
    @media (max-width: 420px){
      .grid{grid-template-columns: 1fr;}
      h1{font-size:34px}
    }

    .month{
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      border: 1px solid rgba(0,0,0,.06);
      min-height: 170px;
    }
    .month .cap{
      padding: 14px 14px 10px;
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap:10px;
    }
    .month .name{
      font-size: 22px;
      font-weight: 900;
      text-transform: lowercase;
      letter-spacing: -.3px;
    }
    .month .num{
      font-weight: 800;
      color: rgba(0,0,0,.45);
      font-size: 12px;
    }
    .month .body{
      padding: 8px 14px 16px;
    }
    .entry{
      display:flex;
      gap: 8px;
      align-items:baseline;
      font-size: 14px;
      margin: 6px 0;
    }
    .day{
      width: 28px;
      text-align:right;
      font-weight: 900;
    }
    .who{
      font-weight: 800;
    }
    .dow{
      color: var(--muted);
      font-weight: 700;
      margin-left: 6px;
      font-size: 12px;
    }
    .empty{
      color: rgba(0,0,0,.35);
      font-style: italic;
      font-size: 13px;
      margin-top: 8px;
    }

    /* Pastel backgrounds */
    .m1{background: #f2f6ea;}
    .m2{background: #e8f4f4;}
    .m3{background: #efe9fb;}
    .m4{background: #e7f7ef;}
    .m5{background: #f2f2f2;}
    .m6{background: #fff2cf;}
    .m7{background: #eaf7ff;}
    .m8{background: #ffe9d6;}
    .m9{background: #fff0e1;}
    .m10{background: #ffe3ee;}
    .m11{background: #eaf6de;}
    .m12{background: #f3ecff;}

    footer{
      margin-top: 22px;
      color: var(--muted);
      font-size: 12px;
    }
    code{background:rgba(0,0,0,.05); padding:2px 6px; border-radius:8px}
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Family birthdays</h1>
        <div class="sub" id="subtitle">Loading…</div>
      </div>

      <div class="controls">
        <button class="btn" id="reloadBtn">Reload Excel</button>
        <label class="btn" for="fileInput" style="display:inline-block;">
          Choose .xlsx
        </label>
        <input id="fileInput" type="file" accept=".xlsx" style="display:none;" />
        <div class="hint">
          Default: <code>./family_birthdays.xlsx</code>
        </div>
      </div>

      <div class="tabs" id="tabs"></div>
    </header>

    <main class="grid" id="grid"></main>

    <footer>
      Put <code>index.html</code> and <code>family_birthdays.xlsx</code> in the same folder.
      If the browser blocks local file fetch, run a tiny server:
      <code>python -m http.server</code>
    </footer>
  </div>

  <script>
    // ---- UI constants ----
    const MONTHS = [
      "january","february","march","april","may","june",
      "july","august","september","october","november","december"
    ];

    // Parsed data will look like:
    // DATA[year] = [{name, mm, dd, dow}, ...]
    let DATA = {};
    let YEARS = [];
    let currentYear = 2026;

    const tabsEl = document.getElementById("tabs");
    const gridEl = document.getElementById("grid");
    const subtitleEl = document.getElementById("subtitle");
    const fileInput = document.getElementById("fileInput");
    const reloadBtn = document.getElementById("reloadBtn");

    // ---- Helpers ----
    function parseCellDate(str){
      // Expecting "MM/DD (요일)" (your Excel output)
      // Example: "07/13 (월)"
      if (!str || typeof str !== "string") return null;
      const m = str.match(/^(\d{2})\/(\d{2})\s*\((.)\)\s*$/);
      if(!m) return null;
      return { mm: parseInt(m[1], 10), dd: parseInt(m[2], 10), dow: m[3] };
    }

    function sheetToMatrix(ws){
      // returns 2D array of values, preserving empty cells as nulls
      return XLSX.utils.sheet_to_json(ws, { header: 1, defval: null });
    }

    function buildDataFromMatrix(mat){
      // Expected format:
      // Row 1: [ "이름", 2026, 2027, ... ]
      // Row 2+: [ "아빠", "07/13 (월)", "07/03 (토)", ... ]
      if (!mat || mat.length < 2) throw new Error("Sheet is empty / wrong format.");

      const header = mat[0];
      const years = header.slice(1).map(v => Number(v)).filter(v => Number.isFinite(v));
      if (years.length === 0) throw new Error("Could not read years from header row.");

      const data = {};
      years.forEach(y => data[y] = []);

      for (let r = 1; r < mat.length; r++){
        const row = mat[r];
        const name = row?.[0];
        if (!name) continue;

        for (let c = 1; c < 1 + years.length; c++){
          const year = years[c - 1];
          const cell = row?.[c];
          const parsed = parseCellDate(cell);
          if (!parsed) continue;

          data[year].push({
            name: String(name),
            mm: parsed.mm,
            dd: parsed.dd,
            dow: parsed.dow
          });
        }
      }

      // Sort each year by month/day
      years.forEach(y => data[y].sort((a,b) => (a.mm - b.mm) || (a.dd - b.dd)));
      return { data, years };
    }

    function makeTabs(){
      tabsEl.innerHTML = "";
      YEARS.forEach(y=>{
        const b = document.createElement("button");
        b.className = "tab" + (y === currentYear ? " active" : "");
        b.textContent = y;
        b.addEventListener("click", ()=>{
          currentYear = y;
          makeTabs();
          renderYear();
        });
        tabsEl.appendChild(b);
      });
    }

    function renderYear(){
      subtitleEl.textContent = `Showing birthdays for ${currentYear}`;
      gridEl.innerHTML = "";

      const entries = DATA[currentYear] || [];
      const byMonth = Array.from({length:12}, ()=>[]);
      entries.forEach(e => byMonth[e.mm - 1].push(e));
      byMonth.forEach(arr => arr.sort((a,b)=> a.dd - b.dd));

      byMonth.forEach((arr, idx)=>{
        const card = document.createElement("section");
        card.className = `month m${idx+1}`;

        const cap = document.createElement("div");
        cap.className = "cap";

        const name = document.createElement("div");
        name.className = "name";
        name.textContent = MONTHS[idx];

        const num = document.createElement("div");
        num.className = "num";
        num.textContent = String(idx+1).padStart(2,"0");

        cap.appendChild(name);
        cap.appendChild(num);

        const body = document.createElement("div");
        body.className = "body";

        if(arr.length === 0){
          const empty = document.createElement("div");
          empty.className = "empty";
          empty.textContent = "No birthdays";
          body.appendChild(empty);
        } else {
          arr.forEach(e=>{
            const row = document.createElement("div");
            row.className = "entry";

            const day = document.createElement("div");
            day.className = "day";
            day.textContent = e.dd;

            const who = document.createElement("div");
            who.className = "who";
            who.textContent = e.name;

            const dow = document.createElement("span");
            dow.className = "dow";
            dow.textContent = `(${e.dow})`;

            who.appendChild(dow);
            row.appendChild(day);
            row.appendChild(who);
            body.appendChild(row);
          });
        }

        card.appendChild(cap);
        card.appendChild(body);
        gridEl.appendChild(card);
      });
    }

    async function loadFromUrl(url){
      const res = await fetch(url);
      if (!res.ok) throw new Error(`Fetch failed: ${res.status}`);
      const ab = await res.arrayBuffer();
      loadFromArrayBuffer(ab);
    }

    function loadFromArrayBuffer(ab){
      const wb = XLSX.read(ab, { type: "array" });
      const firstSheetName = wb.SheetNames[0];
      const ws = wb.Sheets[firstSheetName];

      const mat = sheetToMatrix(ws);
      const { data, years } = buildDataFromMatrix(mat);

      DATA = data;
      YEARS = years;

      // default year: 2026 if available, else first year
      currentYear = YEARS.includes(2026) ? 2026 : YEARS[0];

      makeTabs();
      renderYear();
    }

    // ---- Wire up controls ----
    reloadBtn.addEventListener("click", async ()=>{
      subtitleEl.textContent = "Reloading…";
      try{
        await loadFromUrl("./family_birthdays.xlsx");
      }catch(e){
        subtitleEl.textContent = "Could not fetch ./family_birthdays.xlsx. Use 'Choose .xlsx' or run a local server.";
        console.error(e);
      }
    });

    fileInput.addEventListener("change", async (ev)=>{
      const file = ev.target.files?.[0];
      if(!file) return;
      subtitleEl.textContent = "Loading file…";
      const ab = await file.arrayBuffer();
      loadFromArrayBuffer(ab);
    });

    // ---- Initial load ----
    (async function init(){
      try{
        await loadFromUrl("./family_birthdays.xlsx");
      }catch(e){
        subtitleEl.textContent = "Could not fetch ./family_birthdays.xlsx. Click 'Choose .xlsx' to load it manually (or run python -m http.server).";
        console.error(e);
        // still render empty UI
        DATA = {};
        YEARS = [];
        gridEl.innerHTML = "";
      }
    })();
  </script>
</body>
</html>
